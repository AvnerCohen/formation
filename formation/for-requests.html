
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>For Requests Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../middleware/accept.html" />
    
    
    <link rel="prev" href="../" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">formation</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2" data-path="for-requests.html">
            
                <a href="for-requests.html">
            
                    
                    For Requests
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">media</li>
        
        
    

    
        
        <li class="header">middleware</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../middleware/accept.html">
            
                <a href="../middleware/accept.html">
            
                    
                    Accept
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../middleware/breaker.html">
            
                <a href="../middleware/breaker.html">
            
                    
                    Circuit Breaker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../middleware/context.html">
            
                <a href="../middleware/context.html">
            
                    
                    Context
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../middleware/context_logger.html">
            
                <a href="../middleware/context_logger.html">
            
                    
                    Context Logger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../middleware/duration.html">
            
                <a href="../middleware/duration.html">
            
                    
                    Request Duration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../middleware/logger.html">
            
                <a href="../middleware/logger.html">
            
                    
                    Request Logger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../middleware/request_id.html">
            
                <a href="../middleware/request_id.html">
            
                    
                    Request ID
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="../middleware/retry.html">
            
                <a href="../middleware/retry.html">
            
                    
                    Retry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="../middleware/timeout.html">
            
                <a href="../middleware/timeout.html">
            
                    
                    Timeout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="../middleware/ua.html">
            
                <a href="../middleware/ua.html">
            
                    
                    User Agent
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >For Requests</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="for-requests">For Requests</h1>
<p>While Formation was created as a <em>generic</em> middleware infrastructure, it has special support for <a href="https://github.com/requests/requests" target="_blank">requests</a>.</p>
<p>If you want to create an HTTP client that is production grade: operable, maintainable, and robust -- Formation&apos;s <code>for_requests</code> and <code>middleware</code> submodules contains the building blocks to do so.</p>
<p>Here&apos;s a canonical Google client, created with Formation:</p>
<pre><code class="lang-py"><span class="hljs-keyword">from</span> formation.for_requests <span class="hljs-keyword">import</span> client, html_response
<span class="hljs-keyword">from</span> formation.middleware <span class="hljs-keyword">import</span> request_logger
<span class="hljs-keyword">from</span> attr <span class="hljs-keyword">import</span> attrib, attrs
<span class="hljs-keyword">from</span> attrs_serde <span class="hljs-keyword">import</span> serde
<span class="hljs-keyword">import</span> structlog

<span class="hljs-meta">@serde</span>
<span class="hljs-meta">@attrs</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Query</span><span class="hljs-params">(object)</span>:</span>
    query = attrib(metadata={<span class="hljs-string">&quot;to&quot;</span>: [<span class="hljs-string">&quot;q&quot;</span>]})

<span class="hljs-meta">@client</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Google</span><span class="hljs-params">(object)</span>:</span>
    base_uri = <span class="hljs-string">&quot;https://google.com&quot;</span>
    middleware = [request_logger(structlog.getLogger())]
    response_as = html_response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search</span><span class="hljs-params">(self, text)</span>:</span>
        <span class="hljs-keyword">return</span> self.request.get(<span class="hljs-string">&quot;/&quot;</span>, params=Query(text))


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    google = Google()
    (xml, _code, _headers) = google.search(<span class="hljs-string">&quot;larry page&quot;</span>)
    print(xml.xpath(<span class="hljs-string">&quot;//title/text()&quot;</span>))
</code></pre>
<p>Note that it uses a sister project, <a href="https://github.com/jondot/attrs-serde" target="_blank">attrs-serde</a> to shape queries and data contracts, which helps build a client that feels strongly typed and is more maintainable and has a self-explaining API.</p>
<p>Here&apos;s how you would probably build a client in a production-like settings (imports omitted):</p>
<pre><code class="lang-py"><span class="hljs-meta">@client</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConversionDownloader</span><span class="hljs-params">(object)</span>:</span>
    base_uri = <span class="hljs-string">&quot;https://internal.acme.srv/ads&quot;</span>
    middleware = [
        request_id(),
        context(
            namespace=<span class="hljs-string">&quot;ads&quot;</span>,
            scope=<span class="hljs-string">&quot;conversion-downloader&quot;</span>,
            env=env.get(<span class="hljs-string">&apos;NODE_ENV&apos;</span>, <span class="hljs-string">&apos;development&apos;</span>),
            sha=current_git_sha(),
            version=ads.__version__,
        ),
        request_logger(structlog.getLogger()),
        request_duration(),
        circuit_breaker(),
        timeout(<span class="hljs-number">0.3</span>)
    ]
    response_as = json_response

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span><span class="hljs-params">(self, text)</span>:</span>
        <span class="hljs-keyword">return</span> self.request.get(<span class="hljs-string">&quot;/ad-conversions&quot;</span>, params=Query(text))
</code></pre>
<p>This client tells a story, here&apos;s the important bits.</p>
<h2 id="avoids-cascading-errors">Avoids Cascading Errors</h2>
<p>Cascading errors are the silent killer of production environments. If you pay attention to post-mortems great companies like Amazon, Google publish, in many ways the root cause is a cascading error. </p>
<p>The reason is that usual errors, and even complex errors, are caught by the intelligent people that are already working on these systems at these companies. Cascading errors and their effects notoriously don&apos;t. This only means that we can&apos;t count on intelligence alone, and program <em>defensively</em>, by dividing codebases and separating mechanisms with <a href="https://en.wikipedia.org/wiki/Bulkhead_(partition" target="_blank">bulk heads</a>).</p>
<p>Here are two that operate here:</p>
<ul>
<li><p>This specific client requests are bound by a 300ms limit, enabling predictable workloads. Essentially a bulkhead in the form of timeout or in other words it doesn&apos;t allow for thundering herds effect to happen due to a build-up of slow clients.</p>
</li>
<li><p>It sports a circuit breaker, effectively making error conditions more civilized and keeps bad behavior under a stop-gap mechanism. Based on <code>pybreaker</code>, this one has support for open/half-open/closed and central state management; and is arguably the closest thing in the Python ecosystem to <a href="https://github.com/Netflix/Hystrix" target="_blank">hysterix</a> considered by many as industry standard circuitbreaker implementation.</p>
</li>
</ul>
<h2 id="great-operability-by-default">Great Operability By Default</h2>
<p>Production systems should be <em>operable</em>. They should be as easy to do forensics on, in real time, under stress, as they are to maintain and develop.</p>
<p>This client supports operability because:</p>
<ul>
<li><p>It adds request duration and request context - various bits of data and insights that make sense when shit hits the fan and you need to answer operative questions. How long did it take? on what machine? in what environment? from which code base was this cut? and more.</p>
</li>
<li><p>Correlation ID is added to every request. Generated if missing and carried forward if already given; this allows for traceability and the power to search for a storyline of every business process via one connecting ID in your central log management system.</p>
</li>
<li><p>Finally, a standard structured logging systems makes sure that you get data in a user-friendly way as well as machine friendly way, using <code>structlog</code>.</p>
</li>
</ul>
<h2 id="learning-as-code">Learning as Code</h2>
<p>A huge enabler of modularity in this client, is the formation middleware 
mechanism. It means that what ever learning happens from production or elsewhere, you can codify and build a middleware to solve for. </p>
<p>You then stick it in the middleware stack and hopefully share it share with other services and teams. Before you know it, you have a <em>standard</em> production stack, which is your best practices, living as code, telling <em>your</em> production story and experience.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../" class="navigation navigation-prev " aria-label="Previous page: Introduction">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../middleware/accept.html" class="navigation navigation-next " aria-label="Next page: Accept">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"For Requests","level":"1.2","depth":1,"next":{"title":"Accept","level":"3.1","depth":1,"path":"middleware/accept.md","ref":"middleware/accept.md","articles":[]},"previous":{"title":"Introduction","level":"1.1","depth":1,"path":"README.md","ref":"README.md","articles":[]},"dir":"ltr"},"config":{"plugins":["summary"],"root":"content","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"summary":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"formation/for-requests.md","mtime":"2019-01-01T20:12:46.817Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-01-01T20:20:20.476Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

